#!/usr/bin/env python3import subprocessimport requestsimport timeimport signalimport jsonimport platformimport osfrom datetime import datetimeNAMESPACE = "gobgp-lab"TARGET_PORT = 8080LOCAL_BASE_PORT = 18080# Create experiment folder with timestampTIMESTAMP = datetime.now().strftime("%Y%m%d-%H%M%S")EXPERIMENT_DIR = os.path.join("experiments", TIMESTAMP)os.makedirs(EXPERIMENT_DIR, exist_ok=True)REPORT_FILE = os.path.join(EXPERIMENT_DIR, "report.json")# Global experiment sequence: pod prefix + actionSEQUENCE = [    {"pod": "aachen", "method": "POST", "path": "/pcap/start"},    {"wait": 10},    {"pod": "augsburg", "method": "POST", "path": "/rib/add",     "json": {"prefix": "10.0.0.0/24", "nexthop": "192.0.2.1"}},    {"wait": 30},    {"pod": "aachen", "method": "POST", "path": "/pcap/stop"},]def get_pod_by_prefix(prefix: str) -> str:    cmd = ["kubectl", "get", "pods", "-n", NAMESPACE, "-o", "json"]    out = subprocess.check_output(cmd, text=True)    data = json.loads(out)    for item in data["items"]:        name = item["metadata"]["name"]        phase = item["status"]["phase"]        if phase == "Running" and name.startswith(prefix):            return name    raise RuntimeError(f"No running pod found with prefix '{prefix}'")def port_forward(pod: str, local_port: int):    cmd = [        "kubectl", "port-forward",        f"pod/{pod}", f"{local_port}:{TARGET_PORT}",        "-n", NAMESPACE,    ]    return subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)def stop_process(proc):    if platform.system() == "Windows":        proc.terminate()    else:        proc.send_signal(signal.SIGINT)    try:        proc.wait(timeout=3)    except subprocess.TimeoutExpired:        proc.kill()def run_step(base_url, step, pod_name):    url = base_url + step["path"]    method = step["method"].lower()    kwargs = {}    if "json" in step:        kwargs["json"] = step["json"]    action_entry = {        "pod": pod_name,        "method": step["method"].upper(),        "path": step["path"],    }    if "json" in step:        action_entry["json"] = step["json"]    try:        resp = getattr(requests, method)(url, **kwargs)        try:            parsed = resp.json()        except Exception:            parsed = resp.text        action_entry["result"] = {            "status": resp.status_code,            "response": parsed,        }        # Handle PCAP download on stop        if step["path"] == "/pcap/stop" and resp.status_code == 200:            if isinstance(parsed, dict) and "stopped" in parsed:                fname = parsed["stopped"]                pcap_url = f"{base_url}/pcaps/{fname}"                local_path = os.path.join(EXPERIMENT_DIR, f"{pod_name}-{fname}")                r = requests.get(pcap_url)                if r.status_code == 200:                    with open(local_path, "wb") as f:                        f.write(r.content)                    action_entry["result"]["pcap_file"] = local_path                else:                    action_entry["result"]["pcap_file_error"] = f"Failed to download {pcap_url}"    except Exception as e:        action_entry["result"] = {            "status": "ERROR",            "response": str(e),        }    return {"action": action_entry}def main():    results = []    pod_connections = {}    try:        for step in SEQUENCE:            # Handle wait steps            if "wait" in step:                wait_seconds = step["wait"]                results.append({"wait": wait_seconds})                time.sleep(wait_seconds)                continue            prefix = step["pod"]            if prefix not in pod_connections:                pod_name = get_pod_by_prefix(prefix)                local_port = LOCAL_BASE_PORT + len(pod_connections)                proc = port_forward(pod_name, local_port)                time.sleep(2)                pod_connections[prefix] = (proc, pod_name, local_port)            proc, pod_name, local_port = pod_connections[prefix]            base_url = f"http://localhost:{local_port}"            results.append(run_step(base_url, step, pod_name))    finally:        for proc, _, _ in pod_connections.values():            stop_process(proc)    report = {        "generated": datetime.now().isoformat(),        "namespace": NAMESPACE,        "experiment_dir": EXPERIMENT_DIR,        "sequence": results,    }    with open(REPORT_FILE, "w") as f:        json.dump(report, f, indent=2)    print(f"Experiment saved under {EXPERIMENT_DIR}")if __name__ == "__main__":    main()